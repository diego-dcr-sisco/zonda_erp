function showSpinner() {
    $("#fullscreen-spinner").removeClass("d-none");
}

function hideSpinner() {
    $("#fullscreen-spinner").addClass("d-none");
}

function updateOrder() {
    var order = {
        id: parseInt($("#order-id").val()),
        programmed_date: $("#programmed-date").val(),
        completed_date:
            $("#completed-date").val() != ""
                ? $("#completed-date").val()
                : null,
        start_time: $("#start-time").val(),
        end_time: $("#end-time").val() != "" ? $("#end-time").val() : null,
        status: parseInt($("#order-status").val()),
        folio: parseInt($("#folio").val()),
        closed_by: parseInt($("#closed-by").val()),
        signed_by: $("#signed-by").val(),
        signature_base64: $("#signature-base64").val(),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    var new_formdata = new FormData();
    new_formdata.append("order", JSON.stringify(order));

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/order/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                alert("Orden almacenada!");
            } else {
                alert("Error storing order: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            alert("An error occurred: " + error);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function updateCustomer() {
    var customer = {
        id: parseInt($("#customer-id").val()),
        name: $("#customer-name").val(),
        email:
            $("#customer-email").val() != ""
                ? $("#customer-email").val()
                : null,
        rfc: $("#customer-rfc").val() != "" ? $("#customer-rfc").val() : null,
        address: $("#customer-address").val(),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    var new_formdata = new FormData();
    new_formdata.append("customer", JSON.stringify(customer));

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/customer/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                
                alert("Cliente almacenado!");
            } else {
                
                alert("Error storing customer: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            alert("An error occurred: " + error);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function updateDescription(service_id) {
    var description = {
        service_id: parseInt(service_id),
        text: $(`#service${service_id}-text`).summernote("code"),
        can_propagate: $(`#service${service_id}-can-propagate`).is(":checked"),
        order_id: parseInt($("#order-id").val()),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    var new_formdata = new FormData();
    new_formdata.append("description", JSON.stringify(description));

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/description/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                
                alert("Descripción actualizada!");
            } else {
                alert("Error updating description: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            
            alert("An error occurred: " + error);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function updateNotes() {
    var notes = {
        text: $("#order-notes").summernote("code"),
        order_id: parseInt($("#order-id").val()),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    var new_formdata = new FormData();
    new_formdata.append("notes", JSON.stringify(notes));

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/notes/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                $('#notes').val(notes.text);
                alert("Notas actualizada!");
            } else {
                alert("Error updating description: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            alert("An error occurred: " + error);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function deleteSignature() {
    if (!confirm("¿Está seguro de que desea eliminar la firma? Esta acción no se puede deshacer.")) {
        return;
    }

    var order = {
        id: parseInt($("#order-id").val()),
        programmed_date: $("#programmed-date").val(),
        completed_date: $("#completed-date").val() != "" ? $("#completed-date").val() : null,
        start_time: $("#start-time").val(),
        end_time: $("#end-time").val() != "" ? $("#end-time").val() : null,
        status: parseInt($("#order-status").val()),
        closed_by: parseInt($("#closed-by").val()),
        signed_by: "",
        signature_base64: "",
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    var new_formdata = new FormData();
    new_formdata.append("order", JSON.stringify(order));

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/order/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                // Limpiar la firma en el frontend
                $("#signed-by").val("");
                $("#signature-base64").val("");
                $("#signature-preview").attr("src", "");
                $("#signature-preview").hide();
                
                alert("Firma eliminada correctamente!");
                location.reload(); // Recargar para reflejar los cambios
            } else {
                alert("Error eliminando firma: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            alert("An error occurred: " + error);
        },
        complete: function() {
            hideSpinner();
        }
    });
}
