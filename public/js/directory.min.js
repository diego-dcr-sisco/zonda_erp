var selected_paths = [];
var stack_paths = [];

// Asegurar que `selected_sedes` estÃ© definido (evita errores si no se inicializa en la vista)
if (typeof selected_sedes === 'undefined' || !Array.isArray(selected_sedes)) {
    var selected_sedes = [];
}

$(document).ready(function () {
    $('#tree-dir input[type="checkbox"]').prop("checked", false);

    if (typeof paths !== "undefined") {
        selectDirectory();
    }
});

function formatPath(path) {
    return path.replace(/\s+/g, "").replace(/\//g, "-").replace(/\./g, "_");
}

function getBasename(path) {
    return path.split("/").pop();
}

function getSubdirectories(element) {
    const path = element.dataset.path;
    const url = $("#url-directories").val();
    var formData = new FormData();
    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    formData.append("path", path);

    $.ajax({
        url: '/users/directories',
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            var dirs = response.directories;
            var dir_id = `dir-${formatPath(path)}`;
            var input_id = `input-${formatPath(path)}`;

            var is_checked = $(`#${input_id}`).is(":checked");

            if (stack_paths.includes(dir_id)) {
                $(`#${dir_id} ul`).remove();
                stack_paths = stack_paths.filter(
                    (item_id) => item_id != dir_id
                );
                return;
            }

            var html = `
                    ${$(`#${dir_id}`).html()}
                    <ul class="list-group list-group-flush">
                        ${dirs
                            .map(
                                (dir_path) => `
                            <li class="list-group-item" id="dir-${formatPath(
                                dir_path
                            )}">
                                <input class="form-check-input me-1" type="checkbox" value="${dir_path}/" id="input-${formatPath(
                                    dir_path
                                )}" ${
                                    is_checked ? "checked" : ""
                                } onchange="setDirectory(this)">
                                <button type="button" class="form-check-label btn btn-link p-0" for="input-${formatPath(
                                    dir_path
                                )}"
                                    data-path="${dir_path}" onclick="getSubdirectories(this)">
                                    ${getBasename(dir_path)}
                                </button>
                            </li>
                        `
                            )
                            .join("")}
                    </ul>
                `;

            stack_paths.push(dir_id);
            $(`#${dir_id}`).html(html);
            $(`#${input_id}`).prop("checked", is_checked);

            const checkboxes = $('#tree-dir input[type="checkbox"]');

            checkboxes.each(function () {
                if ($(this).is(":checked")) {
                    var path = $(this).val();
                    if (!selected_paths.includes(path)) {
                        selected_paths.push(path);
                    }
                }
            });
        },
        error: function (error) {
            console.log(error);
        },
    });
}

function setDirectory(element) {
    const path = element.value;
    const id = element.id.replace("input-", "dir-");

    if (element.checked) {
        selected_paths.push(path);
        selected_paths.sort((a, b) => {
            return a.localeCompare(b);
        });

        $(`#${id} input[type="checkbox"]`).prop("checked", true);
    } else {
        if (selected_paths.includes(path)) {
            selected_paths = selected_paths.filter(
                (item_path) => item_path != path
            );

            $(`#${id} input[type="checkbox"]`).prop("checked", false);
        }
    }
}

function selectDirectory() {
    const checkboxes = $('#tree-dir input[type="checkbox"]');

    checkboxes.each(function () {
        var path = $(this).val();
        if (paths.includes(path)) {
            $(this).prop("checked", true);
            selected_paths.push(path);
        } else {
            $(this).prop("checked", false);
        }
    });
}

$("form").on("submit", function (event) {
    event.preventDefault();

    if(selected_sedes.length <= 0) {
        alert('Debes ligar la cuenta a un cliente');
        return;
    }

    if(selected_paths.length <= 0) {
        alert('Debes agregar los permisos a las carpetas');
        return;
    }

    $('#sedes').val(JSON.stringify(selected_sedes.map(item => parseInt(item.id))));
    $("#directories").val(JSON.stringify(selected_paths));
    this.submit();
});
