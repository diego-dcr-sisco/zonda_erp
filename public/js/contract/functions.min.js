    var edit_services = [];

    const dayMap = {
        D: 0, // Domingo
        L: 1, // Lunes
        M: 2, // Martes
        I: 3, // Miércoles
        J: 4, // Jueves
        V: 5, // Viernes
        S: 6, // Sábado
    };
    const day_letters = ["L", "M", "I", "J", "V", "S", "D"];

    var contract_data = [];
    var update_order_data = [];
    var aux = "";

    // Remover el efecto cuando se cierra el modal
    $(document).on("hidden.bs.modal", ".modal", function () {
        $(".modal").removeClass("modal-blur");
    });

    // Genera la fecha de finalizacion del contrato
    function set_endDate() {
        var startDateValue = $("#startdate").val();

        if (startDateValue) {
            var startDate = new Date(startDateValue);

            var endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            endDate.setDate(endDate.getDate() - 1);

            var endDateFormatted = endDate.toISOString().split("T")[0];

            $("#enddate").val(endDateFormatted);
        }
    }

    function createService(service) {
        var i = service.index;
        var hasOrders = typeof orders != "undefined";
        var count = 0;
        service.settings.forEach((setting) => {
            count += setting.dates.length;
        });
        $("#editServiceModalLabel").text(`Editar servicio ${i + 1} [${count}]`);
        var html = `
                <tr>
                    <th scope="row">${i + 1}</th>
                    <td>${service.name}</td>
                    <td id="count-service${
                        service.id
                    }">${count}</td>
                    <td class="d-flex gap-1 justify-content-center">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editServiceModal" onclick="editService(${
                            service.index
                        }, '${
            service.name
        }')"><i class="bi bi-pencil-square"></i></button>
                        <!--button type="button" class="btn btn-dark btn-sm" onclick="duplicateService(${i})"><i class="bi bi-plus-lg"></i> Duplicar</button-->
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteService(${i})"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>
            `;

        return html;
    }

    function editService(index, name) {
        var service = contract_data.find((item) => item.index == index);
        var count = 0;

        edit_services.push(service.id);

        service.settings.forEach((setting) => {
            count += setting.dates.length;
        });
        $("#editServiceModalLabel").text(`Editar servicio ${index + 1} [${count}]`);

        $("#days").val("");
        $("#service-name").val(name);
        $("#frequency").val(1);
        $("#interval").val(1);
        $("#number-days").hide();
        $("#interval").prop("disabled", true);
        $("#days").prop("disabled", true);
        $("#service-index").val(index);

        createSettings(service.id);
    }

    function controlInputs(frequency_op) {
        $("#days").val("");
        $("#letter-days").show();
        $("#interval").val(1);

        if (frequency_op == 1 || frequency_op == 4) {
            $("#interval").prop("disabled", true);
            $("#days").prop("disabled", true);
            $("#number-days").hide();
        }

        if (frequency_op == 2) {
            $("#interval").prop("disabled", true);
            $("#days").prop("disabled", false);
            $("#number-days").hide();
        }

        if (frequency_op == 3) {
            $("#interval").prop("disabled", false);
            $("#days").prop("disabled", false);
            $("#letter-days").hide();
            $("#number-days").show();
        }

        if (frequency_op == 5) {
            $("#interval").val(6);
            $("#interval").prop("disabled", false);
            $("#days").prop("disabled", false);
            $("#number-days").hide();
        }
    }

    function controlDays(interval_op) {
        $("#days").val("");
        $("#number-days").show();
        $("#letter-days").hide();
        $("#days").prop("disabled", false);

        if (interval_op > 1) {
            $("#number-days").hide();
            $("#letter-days").show();
            $("#days").prop("disabled", false);
        }

        if (interval_op == 7) {
            $("#days").prop("disabled", true);
        }
    }

    function setContractData() {
        var index = parseInt($("#service-index").val());
        var pos = contract_data.findIndex((item) => item.index == index);
        var count = 0;
        if (pos != -1) {
            contract_data[pos].settings.forEach((setting) => {
                count += setting.dates.length;
            });
            $("#editServiceModalLabel").text(
                `Editar servicio ${index + 1} [${count}]`
            );
            $(`#count-service${contract_data[pos].id}`).text(count);
        }

        $("#editServiceModal").modal("hide");
    }

    function createServicesList() {
        const startDate = $("#startdate").val();
        const endDate = $("#enddate").val();
        var settings = [];
        

        if (typeof orders != "undefined" && contract_data <= 0) {
            orders.forEach((order) => {
                var dates = [];
                if (order.dates.length > 0) {
                    dates = order.dates.map((date) => new Date(date + "T00:00:00"));
                } else {
                    order.days = JSON.parse(order.days);
                    dates = createDates(order, startDate, endDate);
                    order.days = JSON.stringify(order.days);
                }
                settings.push({
                    index: settings.length,
                    id: order.setting_id,
                    service_id: order.service_id,
                    frequency: order.execution_frequency_id ?? order.frequency,
                    interval: order.interval,
                    days: JSON.parse(order.days),
                    dates: dates,
                    description: order.service_description ?? null,
                });
            });
        } else {
            settings = [];
        }

        if (contract_data.length <= 0) {
            contract_data = selected_services.map((service, i) => {
                return {
                    index: i,
                    id: service.id,
                    prefix: service.prefix,
                    name: service.name,
                    settings: settings.filter(
                        (item) => item.service_id == service.id
                    ),
                };
            });
        } else {
            // Verificar y agregar servicios seleccionados que no existan en contract_data
            selected_services.forEach(service => {
                if(!contract_data.some(data => data.id === service.id)) {
                    contract_data.push({
                        index: contract_data.length,
                        id: service.id,
                        prefix: service.prefix,
                        name: service.name,
                        settings: settings.filter(item => item.service_id == service.id)
                    });
                }
            });

            // Filtrar servicios que ya no están seleccionados
            contract_data = contract_data.filter((data) =>
                selected_services.some((service) => service.id == data.id)
            );

            // Reindexar
            contract_data.forEach((data, i) => {
                data.index = i;
            });
        }
        showServices();
    }

    function showServices() {
        var html = "";
        contract_data.forEach((data) => {
            html += createService(data);
        });

        $("#selected-services").html(html);
    }

    function setDays(index) {
        var exec_type = parseInt($("#exec" + index).val());
        var interval = $("#interval" + index).val();

        var service = contract_data.find((item) => item.index == index);

        if (service) {
            service.interval = parseInt(interval);
        }

        if (exec_type == 3) {
            if (interval == 1) {
                $("#day-letter" + index).hide();
                $("#day-number" + index).show();
            } else {
                $("#day-letter" + index).prop("disabled", false);
                $("#day-letter" + index).show();
                $("#day-number" + index).hide();
            }
        }
    }

    function validateNumberInput(input) {
        let values = input.value.split(",").map((value) => value.trim());
        let last_value = values[values.length - 1];
        let last_num = parseInt(last_value);

        if ((last_num > 31 || last_num < 1) && last_value != "") {
            alert("No puedes ingresar un número menor a 1 o mayor a 31.");
            values[values.length - 1] = aux;
            input.value = values.join(", ");
        } else {
            aux = last_value;
        }
    }

    function validateLetterInput(input) {
        let values = input.value.split(",").map((value) => value.trim());
        let last_value = values[values.length - 1];

        if (last_value != "") {
            if (!day_letters.includes(last_value)) {
                alert(
                    "No puedes ingresar una en mayusculas correspondientes a cada dia."
                );
                values[values.length - 1] = aux;
                input.value = values.join(", ");
            }
        }
    }

    function deleteService(index) {
        if (index < 0 || index >= contract_data.length) {
            console.error("Índice no válido");
            return;
        }

        var service = contract_data[index];

        let selectedIndex = selected_services.findIndex(
            (item) => item.id == service.id
        );
        if (selectedIndex != -1) {
            selected_services.splice(selectedIndex, 1);
            $("#service" + service.id).removeClass("active");
        }

        contract_data.splice(index, 1);
        contract_data.forEach((item, idx) => (item.index = idx));
        $("#settings").html("");
        showServices();
    }

    function duplicateService(index) {
        if (index < 0 || index > contract_data.length) {
            console.error("Posición no válida");
            return;
        }

        var item = { ...contract_data[index] };
        item.index = contract_data.length;
        contract_data.push(item);
        showServices();
    }

    function generateDatesByNumber(startDate, endDate, days) {
        const dates = [];
        const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        let start = new Date(startDate + "T00:00:00");
        let end = new Date(endDate + "T00:00:00");

        const isLeapYear = (year) =>
            (year % 4 == 0 && year % 100 != 0) || year % 400 == 0;

        while (start <= end) {
            let month = start.getMonth();
            let year = start.getFullYear();
            let daysInCurrentMonth = daysInMonth[month];

            if (month == 1 && isLeapYear(year)) {
                daysInCurrentMonth = 29; // February in a leap year
            }

            const validDays = days
                .map((d) =>
                    d == 31 && daysInCurrentMonth < 31 ? daysInCurrentMonth : d
                )
                .filter((d) => d <= daysInCurrentMonth);

            if (validDays.includes(start.getDate())) {
                dates.push(new Date(start));
            }

            start.setDate(start.getDate() + 1);
        }

        return dates;
    }

    function sortDates(dateArray) {
        return dateArray.sort((a, b) => a - b);
    }

    function generateDatesByLetter(startDate, endDate, days) {
        const dates = [];
        const day_indexs = days
            .map((day) => dayMap[day])
            .filter((index) => index != undefined);

        day_indexs.forEach((index) => {
            let start = new Date(startDate + "T00:00:00");
            let end = new Date(endDate + "T00:00:00");

            

            while (index != start.getDay()) {
                start.setDate(start.getDate() + 1);
            }

            while (start <= end) {
                if (day_indexs.includes(start.getDay())) {
                    dates.push(new Date(start));
                }
                start.setDate(start.getDate() + 7);
            }
        });

        return sortDates(dates);
    }

    function generateDatesByInterval(startDate, endDate, days, interval) {
        const dates = [];
        const day_indexs = days
            .map((day) => dayMap[day])
            .filter((index) => index !== undefined);

        const getNthWeekday = (year, month, dayOfWeek, n) => {
            let date = new Date(year, month, 1);
            // Ajusta al primer día de la semana deseada
            date.setDate(((dayOfWeek - date.getDay() + 7) % 7) + 1);

            if (n == 5) {
                // Caso especial: última ocurrencia del día en el mes
                let lastDay = new Date(year, month + 1, 0); // Último día del mes
                let diff = (lastDay.getDate() - date.getDate()) / 7;
                let lastOccurrence = date.getDate() + Math.floor(diff) * 7;
                date.setDate(lastOccurrence);
            } else if (n > 1) {
                // Caso normal: enésima ocurrencia
                date.setDate(date.getDate() + (n - 1) * 7);
            }
            return date;
        };

        let current = new Date(startDate + 'T00:00:00');

        while (current <= new Date(endDate)) {
            let year = current.getFullYear();
            let month = current.getMonth();

            for (const dayIndex of day_indexs) {
                let date = getNthWeekday(year, month, dayIndex, interval);
                // Verifica que la fecha esté dentro del mes actual (evita desbordamiento)
                if (date.getMonth() === month) {
                    dates.push(new Date(date));
                }
            }

            current.setMonth(current.getMonth() + 1);
            current.setDate(1);
        }

        return dates;
    }

    function generateDatesByPeriod(startDate, endDate, days) {
        const dates = [];
        const day_indexs = days
            .map((day) => dayMap[day])
            .filter((index) => index != undefined);

        day_indexs.forEach((index) => {
            let start = new Date(startDate + "T00:00:00");
            let end = new Date(endDate + "T00:00:00");

            //start.setDate(start.getDate() + 1);
            //end.setDate(end.getDate() + 1);

            while (index != start.getDay()) {
                start.setDate(start.getDate() + 1);
            }

            while (start <= end) {
                if (day_indexs.includes(start.getDay())) {
                    dates.push(new Date(start));
                }
                start.setDate(start.getDate() + 14);
            }
        });

        return dates;
    }

    function getAllDatesBetween(startDate, endDate) {
        const dates = [];
        let current = new Date(startDate + "T00:00:00");
        const end = new Date(endDate + "T00:00:00");

        if (end < current) {
            throw new Error("End date must be after start date");
        }

        while (current <= end) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }

        return dates;
    }

    /*function createDates(service, startDate, endDate) {
        var new_dates = [];
        switch (service.frequency) {
            case 1:
                new_dates.push(startDate);
                break;
            case 2:
                new_dates = generateDatesByLetter(startDate, endDate, service.days);
                break;
            case 3:
                if (service.interval > 0) {
                    new_dates =
                        service.interval == 1
                            ? generateDatesByNumber(
                                startDate,
                                endDate,
                                service.days.map(Number)
                            )
                            : generateDatesByInterval(
                                startDate,
                                endDate,
                                service.days,
                                service.interval - 1
                            );
                } else {
                    alert(
                        "El intervalo seleccionado para el servicio " +
                            service.index +
                            " es incorrecto"
                    );
                }
                break;
            case 4:
                
                new_dates = getAllDatesBetween(startDate, endDate);
                break;
            case 5:
                new_dates = generateDatesByPeriod(startDate, endDate, service.days);
                break;
            default:
                alert("La frecuencia no se encuentra en la lista de opciones");
                break;
        }

        return new_dates;
    }*/

    function showPreview(pos, index) {
        if (pos != -1) {
            if ($(".modal.show").length) {
                $(".modal.show").addClass("modal-blur");
            }

            const startDate = $("#startdate").val();
            const endDate = $("#enddate").val();
            var count = 0;

            if (contract_data[pos].settings[index].dates <= 0) {
                if (contract_data[pos].settings.length > 0) {
                    contract_data[pos].settings.forEach((setting) => {
                        setting.dates = [];
                        setting.dates = createDates(setting, startDate, endDate);
                        setting.dates.sort((a, b) => new Date(a) - new Date(b));
                        count += setting.dates.length;
                    });
                }
                $(`#count-service${contract_data[pos].id}`).text(count);
            }

            $("#preview").html(datePreview(pos, index));
            $("#datesModal").modal("show");
        }
    }

    function datePreview(pos, index) {
        var service = contract_data[pos];
        var setting = service.settings[index];
        var dates = setting.dates.sort((a, b) => new Date(a) - new Date(b));
        var html = `
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold"> ${service.name} [${dates.length}] </h5>
                <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="   " data-bs-target="#collapseNewDate" aria-expanded="false" aria-controls="collapseExample">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <div class="collapse mb-3" id="collapseNewDate">
                <div class="card card-body">
                    <div class="input-group input-group-sm mb-3">
                        <label for="new-date" class="form-label me-2">Nueva fecha</label>
                        <input type="date" class="form-control" id="newdate-pos${pos}-index${index}" name="date" value="">
                        <button class="btn btn-primary" type="button" onclick="createDate(${pos}, ${index})">Agregar</button>
                    </div>
                </div>
            </div>
            <div class="list-group">
            ${dates
                .map(
                    (date, i) =>
                        ` <div class="input-group input-group-sm mb-3">
                            <input type="date" class="form-control" id="service${
                                service.id
                            }-date${i}" name="date" value="${convertDate(
                            date
                        )}" onchange="updateDate(this.value, ${pos}, ${index}, ${i})">
                            <button class="btn btn-danger" type="button" onclick="deleteDate(${pos}, ${index}, ${i})"><i class="bi bi-trash-fill"></i> Eliminar</button>
                        </div> `
                )
                .join("")}
            </div>
        `;
        return html;
    }

    function convertDate(date) {
        if (date instanceof Date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0"); // Los meses se cuentan desde 0
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        } else {
            return date;
        }
    }

    function createDate(pos, index) {
        var date = new Date($(`#newdate-pos${pos}-index${index}`).val());
        date.setDate(date.getDate() + 1);
        contract_data[pos].settings[index].dates.push(date);
        $("#preview").html(datePreview(pos, index));
    }

    function updateDate(value, pos, index, i) {
        var date = new Date(value);
        date.setDate(date.getDate() + 1);
        contract_data[pos].settings[index].dates[i] = date;
    }

    /*function deleteDate(pos, index, date_index) {
        contract_data[pos].settings[index].dates.splice(date_index, 1);
        $("#preview").html(datePreview(pos, index));
    }*/

    function submitContract() {
        const customer = $("#customer_id").val();
        const startDate = $("#startdate").val();
        const endDate = $("#enddate").val();
        const technicians = JSON.parse($("#technicians").val());

        if (customer == 0) {
            alert("Selecciona el cliente");
            return;
        }

        if (startDate == "" && endDate == "") {
            alert("Incluye la fecha de inicio y/o finalización del contrato");
            return;
        }


        if (technicians.length <= 0) {
            alert("Selecciona a los técnicos");
            return;
        }

        contract_data.forEach((service) => {
            service.settings.forEach((setting) => {
                setting.dates = setting.dates.map((date) => convertDate(date));
            });
        });

        $("#contract-data").val(JSON.stringify(contract_data));
        $("#edit-services").val(JSON.stringify(edit_services));

        if (confirm("¿Estás seguro actualizar el contrato?")) {
            $("#contract-form").submit();
        }
    }

    function updateOrders(order_id) {
        var start_time = $(`#order${order_id}-start-time`).val();
        var programmed_date = $(`#order${order_id}-programmed-date`).val();
        var pos = update_order_data.findIndex((item) => item.order_id == order_id);

        if (pos != -1) {
            update_order_data[pos].start_time = start_time;
            update_order_data[pos].programmed_date = programmed_date;
        } else {
            update_order_data.push({
                order_id: order_id,
                start_time: start_time,
                programmed_date: programmed_date,
            });
        }
    }

    function setSettings() {
        var html = ``;
        var index = $("#service-index").val();
        var pos = contract_data.findIndex((item) => item.index == index);
        var frequency = parseInt($("#frequency").val());
        var interval = parseInt($("#interval").val());

        const startDate = $("#startdate").val();
        const endDate = $("#enddate").val();

        if (startDate == "" || endDate == "") {
            alert("Incluye la fecha de inicio y/o finalización del contrato");
            return;
        }

        if (contract_data.length <= 0) {
            alert("Añade y/o configura los servicios");
            return;
        }

        if (pos != -1) {
            var days = $(
                "#letter-days:visible #days, #number-days:visible #days"
            ).val();

            var split_days = days.split(",").map((day) => day.trim());

            // Agregar siempre una nueva configuración sin verificar duplicados
            contract_data[pos].settings.push({
                index: contract_data[pos].settings.length,
                id: null,
                frequency: frequency,
                interval: interval,
                days: split_days,
                dates: createDates(
                    { frequency, interval, days: split_days },
                    startDate,
                    endDate
                ),
                service_description: null,
            });

            // Generar la lista de configuraciones para mostrar en el HTML
            contract_data[pos].settings.forEach((setting, index) => {
                html += createSetting(setting, pos, index);
            });

            $("#settings").html(html);
        }
    }


    function createSettings(service_id) {
        var html = ``;
        var pos = contract_data.findIndex((item) => item.id == service_id);
        if (pos != -1) {
            contract_data[pos].settings.forEach((setting, index) => {
                html += createSetting(setting, pos, index);
            });
            $("#settings").html(html);
        }
    }

    function deleteSetting(pos, index) {
        contract_data[pos].settings.splice(index, 1);
        contract_data[pos].settings.forEach((setting, index) => {
            setting.index = index;
        });
        createSettings(contract_data[pos].id);
    }


    function saveDescription(pos, index) {
        if (pos != -1) {
            contract_data[pos].settings[index].description =
                $("#summary-describe").summernote("code");
        }
        $("#describeModal").modal("hide");
    }
