// Asegurar que `selected_sedes` esté definido (evita errores si no se inicializa en la vista)
if (typeof selected_sedes === 'undefined' || !Array.isArray(selected_sedes)) {
    var selected_sedes = [];
}

function generatePassword() {
    const prefix = "@sp.";
    const characters =
        //"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        "abcdefghijklmnopqrstuvwxyz0123456789";
    let password = prefix;

    for (let i = 4; i < 8; i++) {
        const index_random = Math.floor(Math.random() * characters.length);
        password += characters.charAt(index_random);
    }

    $("#password").val(password);
}

function restiction(value) {
    if (value == 3) {
        var pos = $(".option-department").index(
            $(".option-department:contains('Operaciones')"),
        );
        $(".option-department").eq(pos).prop("selected", true);
        $("#wk-department").prop("disabled", true);
        $("#work-department").val($(".option-department")[pos].value);
    } else {
        $("#wk-department").prop("disabled", false);
    }
}

function updatePassword() {
    var message = "¿Estas seguro de modificar la contraseña?";

    if (confirm(message)) {
        $("#password").prop("disabled", false);
    }
}

function searchSedes() {
    var form_data = new FormData();
    var search = $("#search-sedes").val();
    var csrfToken = $('meta[name="csrf-token"]').attr("content");

    if (search == "") {
        alert("El campo de busqueda no debe estar vacio");
        return;
    }

    form_data.append("search", search);

    $.ajax({
        url: "/users/search/sedes",
        type: "POST",
        data: form_data,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            var data = response.sedes;
            if (data.length > 0) {
                $("#sedesList").empty();
                $.each(data, function (index, item) {
                    var is_checked = selected_sedes.find(
                        (elem) => elem.id == item.id,
                    );
                    $("#sedesList").append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <input class="form-check-input me-2" type="checkbox" value="${
                                    item.id
                                }" ${is_checked ? "checked" : ""}>
                                ${item.name}
                            </div>
                            <span class="badge bg-dark rounded-pill">${
                                item.matrix.name
                            }</span>
                        </li>
                    `);
                });
                $("#sedesModal").modal("show");
            } else {
                alert("No se encontraron coincidencias");
                return;
            }
        },
        error: function (error) {},
    });
}

function setSedes() {
    const allCheckboxes = [];

    $('#sedesList input[type="checkbox"]').each(function () {
        allCheckboxes.push({
            id: parseInt($(this).val()),
            name:
                $(this).next("label").text() ||
                $(this).parent().text().trim(),
            is_checked: $(this).is(":checked"),
        });
    });

    // Mapa para búsqueda rápida
    const checkboxMap = new Map();
    allCheckboxes.forEach(cb => checkboxMap.set(cb.id, cb));

    // 1️⃣ Eliminar de selected_sedes los que estén desmarcados
    selected_sedes = selected_sedes.filter(sede => {
        const checkbox = checkboxMap.get(sede.id);

        // Si no existe en checkboxes, se mantiene
        if (!checkbox) return true;

        // Si existe y está marcado, se mantiene
        return checkbox.is_checked;
    });

    // 2️⃣ Agregar SOLO los marcados que NO existan aún
    allCheckboxes.forEach(cb => {
        if (
            cb.is_checked &&
            !selected_sedes.some(s => s.id === cb.id)
        ) {
            selected_sedes.push(cb);
        }
    });

    console.log(selected_sedes);

    showSedes();
}


function showSedes() {
    // Verificar si hay sedes seleccionadas
    if (!selected_sedes || selected_sedes.length == 0) {
        $("#sedesTable tbody").html(
            '<tr><td colspan="2" class="text-muted">No hay clientes asociados</td></tr>',
        );
        return;
    }

    // Generar filas HTML
    const rowsHtml = selected_sedes
        .map(
            (item) => `
        <tr>
            <td>${item.name}</td>
            <td>
                <button class="btn btn-sm btn-danger" data-id="${item.id}" onclick="removeSede(${item.id})">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </td>
        </tr>
    `,
        )
        .join(""); // Convertir array a string

    // Insertar en la tabla
    $("#sedesTable tbody").html(rowsHtml);
}

function removeSede(sede_id) {
    selected_sedes = selected_sedes.filter((item) => item.id != sede_id);
    showSedes();
}

function setDataForm() {
    $("#sedes").val(JSON.stringify(selected_sedes));
}
