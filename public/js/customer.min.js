var customers_data = [];
var selected_customer = 0;
var selected_customer_id = 0;

var client_ids = [];
var client_data = [];
var all_customers_data = [];

$(document).ready(function () {
    $(".customer:checked").each(function () {
        client_ids.push(parseInt($(this).val()));
    });
    $("#customers").val(JSON.stringify(client_ids));

    if (typeof contract == "undefined") {
        contracts = [];
    }

    $("#customerSearch").on("input", function () {
        filterCustomers();
    });

    // Event listener para tecla Enter en el filtro
    $("#customerSearch").on("keypress", function (e) {
        if (e.which === 13) {
            e.preventDefault();
            // Si hay solo un resultado después de filtrar, seleccionarlo automáticamente
            var visibleCustomers = $("#customer-list .list-group-item");
            if (visibleCustomers.length === 1) {
                var customerId = $(visibleCustomers)
                    .find('input[type="radio"]')
                    .val();
                setCustomer(parseInt(customerId));
            }
        }
    });
});

function searchCustomer() {
    var formData = new FormData();
    var url = $("#url-customer").val();
    var name = $("#customer-name").val();
    var phone = $("#customer-phone").val();
    var address = $("#customer-address").val();

    if (name == "" && phone == "" && address == "") {
        alert("Debes introducir al menos 1 dato de busqueda.");
        return;
    }

    deleteCustomer();

    formData.append("customer_name", name);
    formData.append("customer_phone", phone);
    formData.append("customer_address", address);

    getCustomers(formData, url);
}

function getCustomers(formData, url) {
    var html = "";
    var csrfToken = $('meta[name="csrf-token"]').attr("content");

    $.ajax({
        url: url,
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            var customers = response["customers"];
            var client_customers = response["client_customers"];
            var i = 0;
            var arrFathers = [];
            customers_data = [];
            all_customers_data = []; // Reiniciar datos globales

            if (customers.length > 0) {
                customers.forEach(function (item) {
                    if (!arrFathers.includes(item.id)) {
                        var customerItem = {
                            index: i,
                            id: item.id,
                            type: "Cliente",
                            name: item.name,
                            phone: item.phone == null ? "---" : item.phone,
                            address:
                                item.address == null ? "---" : item.address,
                            code: item.code == null ? "---" : item.code,
                            status: selected_customer == item.id,
                        };
                        customers_data.push(customerItem);
                        all_customers_data.push(customerItem); // Guardar copia completa
                    }
                    i++;
                });
            }

            if (new_client_account == true) {
                // Lógica para new_client_account (tu código existente)
                html += `<div class="accordion" id="accordionClient">`;
                client_customers.forEach((item) => {
                    html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${
                                item.id
                            }" aria-expanded="false">
                                ${item.name}
                            </button>
                        </h2>
                        <div id="collapse${
                            item.id
                        }" class="accordion-collapse collapse" data-bs-parent="#accordionClient">
                            <div class="accordion-body">
                                ${item.sedes
                                    .map(
                                        (sede) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${
                                        sede.id
                                    }" id="sede${
                                        sede.id
                                    }" onchange="setClientId(this.value, '${
                                        sede.name
                                    }')" ${
                                        client_ids.includes(sede.id)
                                            ? "checked"
                                            : ""
                                    }>
                                    <label class="form-check-label" for="sede${
                                        sede.id
                                    }">
                                        ${sede.name}
                                    </label>
                                </div>`,
                                    )
                                    .join("")}
                            </div>
                        </div>
                    </div>`;
                });
                html += `</div>`;

                $("#fetch-customers").html(html);
                $("#customerModal").modal("show");
            } else {
                if (customers_data.length > 0) {
                    renderCustomerList(customers_data);
                    $("#customerModal").modal("show");
                } else {
                    alert("Sin coincidencias");
                }
            }
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
        },
    });
}

//Función para renderizar la lista de clientes
function renderCustomerList(customersToRender) {
    var html = "";
    var customer_id = $("#customer-id").val();
    const customer = customersToRender.find((item) => item.id == customer_id);
    selected_customer = customer_id > 0 ? customer_id : 0;

    if (customersToRender.length > 0) {
        html += `<div class="list-group">`;
        customersToRender.forEach(function (item) {
            html += `
            <table class="table table-hover table-striped">
    <thead class="table-light">
        <tr>
            <th style="width: 40px;" class="ps-3">Seleccionar</th>
            <th>Cliente</th>
            <th>ID</th>
            <th>Código</th>
            <th>Telefono</th>
            <th>Dirección</th>
        </tr>
    </thead>
    <tbody>
        <!-- Aquí irían las filas generadas dinámicamente -->
        <tr class="align-middle">
            <td class="ps-3" style="width: 40px;">
                <div class="form-check">
                    <input class="form-check-input border border-dark" 
                           type="radio" 
                           name="customerRadio" 
                           id="customerRadio${item.id}" 
                           value="${item.id}" 
                           ${
                               item.status || selected_customer == item.id
                                   ? "checked"
                                   : ""
                           }
                           onchange="setCustomer(${item.id})">
                </div>
            </td>
            <td>${item.name}</td>
            <td>${item.id}</td>
            <td class="fw-bold">${item.code}</td>
            <td>${item.phone}</td>
            <td class="text-muted">${item.address}</td>
        </tr>
    </tbody>
</table>
            `;
        });
        html += `</div>`;
    } else {
        html = `<div class="alert alert-info">No se encontraron clientes que coincidan con el filtro.</div>`;
    }

    $("#customer-list").html(html);
    updateSelectedCount();

    if (customer) {
        createCustomer(customer);
        if (contracts.length > 0) {
            selectContract(selected_customer);
        }
    }
}

// Función para filtrar clientes en tiempo real
function filterCustomers() {
    var searchText = $("#customerSearch").val().toLowerCase().trim();

    if (searchText === "") {
        // Si no hay texto, mostrar todos los clientes
        renderCustomerList(all_customers_data);
        return;
    }

    // Filtrar clientes que coincidan con el texto de búsqueda
    var filteredCustomers = all_customers_data.filter(function (customer) {
        return (
            customer.name.toLowerCase().includes(searchText) ||
            customer.id.toString().includes(searchText) ||
            customer.phone.toLowerCase().includes(searchText) ||
            customer.address.toLowerCase().includes(searchText)
        );
    });

    renderCustomerList(filteredCustomers);
}

function updateSelectedCount() {
    var count = selected_customer > 0 ? 1 : 0;
    $("#selected-count").text(count + " cliente(s) seleccionado(s)");
    $("#selected-count").toggleClass("bg-primary", count > 0);
    $("#selected-count").toggleClass("bg-secondary", count === 0);
}

// Función para confirmar la selección
function confirmSelection() {
    if (selected_customer > 0) {
        $("#customerModal").modal("hide");
        var customer_data = all_customers_data.find(
            (item) => item.id == selected_customer,
        );

        $html = `
        <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm">
                    <thead class="table-success">
                        <tr>
                            <th colspan="2" class="text-center">
                                Cliente Seleccionado
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="fw-bold" style="width: 30%;">Nombre:</td>
                            <td class="text-primary fw-bold">${customer_data.name}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Código:</td>
                            <td>
                                ${customer_data.code}
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">ID:</td>
                            <td>
                                ${customer_data.id}
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Dirección:</td>
                            <td class="text-muted">${customer_data.address}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Tipo:</td>
                            <td>${customer_data.type}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </div>
        `;

        $("#selected-customer-container").html($html);
    } else {
        alert("Por favor selecciona un cliente antes de confirmar.");
    }
}

function setCustomer(customer_id) {
    const customer = all_customers_data.find((item) => item.id == customer_id);
    if (customer) {
        selected_customer = customer_id;

        // Actualizar el estado de todos los items
        all_customers_data.forEach((item) => {
            item.status = item.id == customer_id;
        });

        createCustomer(customer);

        if (contracts.length > 0) {
            selectContract(selected_customer);
        }

        $("#customer-id").val(selected_customer);
        updateSelectedCount();

        // Actualizar visualmente el radio button seleccionado
        $('input[name="customerRadio"]').prop("checked", false);
        $("#customerRadio" + customer_id).prop("checked", true);
    }
}

function selectContract(customer_id) {
    $("#contract").empty().append(new Option("Sin contrato", "0"));

    const selected_contracts = contracts.filter(
        (contract) => contract.customer_id == customer_id,
    );
    selected_contracts.map((contract) => {
        $("#contract").append(
            new Option(
                `Contrato ${contract.id} (${contract.startdate} - ${contract.enddate})`,
                `${contract.id}`,
            ),
        );
    });
}

function createCustomer(customer) {
    $("#customer-select").html(
        `<div class="alert alert-success" role="alert">
            <div class="d-flex justify-content-between">
                <h4 class="alert-heading">Cliente seleccionado</h4>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="deleteCustomer()"></button>
            </div>
            <ul>
                <li class="text-break fw-bold">Cliente: <span class="fw-normal">${
                    customer.sede ? customer.sede : customer.name
                }</span></li>
                <li class="text-break fw-bold">Teléfono: <span class="fw-normal">${
                    customer.phone
                }</span></li>
                <li class="text-break fw-bold">Dirección: <span class="fw-normal">${
                    customer.address
                }</span></li>
            </ul>
        </div>`,
    );
}

function createClient() {
    $("#customer-select").html(
        `<div class="alert alert-success" role="alert">
            <div class="d-flex justify-content-between">
                <h4 class="alert-heading">Sedes seleccionadas</h4>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="deleteCustomer()"></button>
            </div>
            <ul>
                ${client_data
                    .filter((client) => client_ids.includes(client.id)) // Filtra clientes que estén en client_ids
                    .map(
                        (client) => `
                    <li class="text-break fw-bold">Sede: <span class="fw-normal">${client.name}</span></li>`,
                    )
                    .join("")}
            </ul>
        </div>`,
    );
}

function deleteCustomer() {
    selected_customer = 0;
    client_ids = [];
    $("#customer-id").val("");
    $("#customers").val("");
    $("#contract").empty().append(new Option("Sin contrato", "0"));
}

function setClientId(id, name) {
    id = parseInt(id);
    if (!client_ids.includes(id)) {
        client_ids.push(id);
        client_data.push({
            id: id,
            name: name,
        });
    } else {
        client_ids = client_ids.filter((clientId) => clientId != id);
        client_data = client_data.filter((client) => client.id != id);
    }
    $("#customers").val(JSON.stringify(client_ids));

    createClient();
    if (client_ids <= 0) {
        deleteCustomer();
        $(".alert").alert("close");
    }
}
