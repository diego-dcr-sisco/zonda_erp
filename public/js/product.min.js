var selected_products = [];
var products = [];
var product_indexs = [];
var periods = [];
var months = [];
var changes = [];

$(document).ready(function () {
    if (typeof fetched_products != "undefined") {
        selected_products = fetched_products;
    }

    if (typeof fetched_changes != "undefined") {
        changes = fetched_changes;
    }

    if (typeof found_months != "undefined") {
        months = found_months;
    }

    setProducts();
    paintChanges();
});

function getProducts() {
    const csrfToken = $('meta[name="csrf-token"]').attr("content");
    var formData = new FormData();
    var input_text = $("#search").val();
    var url = $("#url-search-product").val();
    var html = ``;

    formData.append("search", JSON.stringify(input_text));

    if (input_text != "") {
        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            headers: {
                "X-CSRF-TOKEN": csrfToken,
            },
            success: function (response) {
                products = response;
                if (products.length > 0) {
                    products.forEach((product) => {
                        html += `
                            <a id="product${
                                product.id
                            }" class="list-group-item list-group-item-action ${
                            product.status ? "active" : ""
                        }" onclick="selectProduct(${product.id})">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1 fw-bold">[${product.id}] ${
                            product.name
                        }</h5>
                                </div>
                                <ul>
                                <li class="text-break fw-bold">Utilización: <span class="fw-normal">${
                                    product.biocide_group ?? "S/A"
                                }</span></li>
                                    <li class="text-break fw-bold">Ingrediente Activo: <span class="fw-normal">${
                                        product.active_ingredient ?? "S/A"
                                    }</span></li>
                                </ul>
                            </a>
                        `;
                    });
                }
                $("#product-list").html(html);
                $("#productModal").modal("show");
            },
            error: function (error) {},
        });
    } else {
        alert("Debes introducir el nombre del producto/materia activa");
    }
}

function selectProduct(productId) {
    var found_product = products.find((item) => item.id == productId);
    var fetched_product = selected_products.find(
        (item) => item.id == productId
    );
    var element = $(`#product${productId}`);

    if (!fetched_product) {
        selected_products.push({
            index: selected_products.length,
            id: found_product.id,
            name: found_product.name,
            group: found_product.biocide_group ?? "S/A",
            //type: found_product.biocide_type ?? 'S/A',
            active_ingredient: found_product.active_ingredient ?? "S/A",
            status: true,
            color: "#000000",
            months: [],
        });

        element.addClass("active");
    } else {
        if (element.hasClass("active")) {
            selected_products = selected_products.filter(
                (item) => item.id != productId
            );
            selected_products.forEach((product, index) => {
                product.index = index;
            });
            element.removeClass("active");
        }
    }
}

function setProducts() {
    var html = ``;
    selected_products.forEach((product, index) => {
        html += paintProduct(product, index);
    });
    $("#selected-products").html(html);
    $("#productModal").modal("hide");

    //paintProducts(index);
}

function paintProduct(product, index) {
    var months_join =
        selected_products[index].months.length > 0
            ? selected_products[index].months
                  .map((i) => {
                      const fetch_month = months.find((m) => m.index == i);
                      return fetch_month ? fetch_month.name.toUpperCase() : "";
                  })
                  .filter(Boolean)
                  .join(", ")
            : "-";

    var html = `
            <tr>
                <th scope="row">${index + 1}</th>
                <td>${product.name}</td>
                <td>${product.group}</td>
                <td>${product.active_ingredient}</td>
                <td><input type="color" class="form-control" value="${
                    product.color
                }" onchange="setColor(${index}, this.value)"></td>
                <td>${months_join}</td>
                <td>
                    <button type="button" class="btn btn-warning btn-sm" onclick="duplicateProduct(${index})"><i class="bi bi-plus-lg"></i> Duplicar</button>
                    <button type="button" class="btn btn-info btn-sm" onclick="showMonths(${index})"><i class="bi bi-calendar-fill"></i> Meses</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteProduct(${index})"><i class="bi bi-trash-fill"></i> Eliminar</button>
                </td>
            </tr>
        `;
    return html;
}

function setColor(index, value) {
    selected_products[index].color = value;
}

function deleteProduct(index) {
    selected_products.splice(index, 1);
    setProducts();
}

function duplicateProduct(index) {
    const duplicatedProduct = {
        ...selected_products[index],
        months: [...selected_products[index].months], // Copia el array de meses
    };

    selected_products.push(duplicatedProduct);

    for (let i = 0; i < selected_products.length; i++) {
        selected_products[i].index = i;
    }
    setProducts();
}

function showMonths(index) {
    var html = ``;
    months.forEach((month) => {
        html += `
        <li class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" value="${
                month.index
            }" id="product${index}-month${
            month.index
        }" onchange="setMonth(${index}, this)" ${
            selected_products[index].months.includes(month.index)
                ? "checked"
                : ""
        }>
            <label class="form-check-label stretched-link" for="product${index}-month${
            month.index
        }">${month.name.toUpperCase()}</label>
        </li>`;
    });
    $("#months-list").html(html);
    $("#monthModal").modal("show");
    $("#product-index").val(index);
}

function setMonth(index, element) {
    const is_checked = element.checked;
    const value = parseInt(element.value);

    if (is_checked) {
        if (!selected_products[index].months.includes(value)) {
            selected_products[index].months.push(value);
        }
    } else {
        const valueIndex = selected_products[index].months.indexOf(value);
        if (valueIndex != -1) {
            selected_products[index].months.splice(valueIndex, 1); // Elimina el elemento
        }
    }
}

function closeMonths() {
    var html = "";
    $("#monthModal").modal("hide");
    selected_products.forEach((product, index) => {
        html += paintProduct(product, index);
    });
    $("#selected-products").html(html);
}

function hasProducts() {
    if (selected_products.length <= 0) {
        alert("Carácter no permitido");
        return;
    }
    $("#product-indexs").val("");
    $("#dateModal").modal("show");
}

function verifyProduct(input) {
    const regex = /^(\d+[\s,]*)*$/;
    const allowedValues = selected_products.map((item) => item.index + 1);

    // Verificar el formato del input
    if (!regex.test(input.trim())) {
        alert(`Las letras no estan permitidas.`);
        $("#product-indexs").val(product_indexs.join(","));
        return;
    }

    const cleanedInput = input
        .split(/[\s,]+/)
        .filter(Boolean)
        .join(",");
    const numbers = cleanedInput.split(",").map((item) => parseInt(item));
    const lastNumber = numbers[numbers.length - 1];

    if (lastNumber > 0 && !allowedValues.includes(lastNumber)) {
        alert(
            `Valor fuera de rango. Solo se permiten los siguientes valores ${allowedValues.join(
                ", "
            )}.`
        );
        $("#product-indexs").val(product_indexs.join(","));
        return;
    }

    product_indexs = numbers;
}

function setDates(index) {
    const start_date = $(`#table-body-date-start${index}`).val();
    const end_date = $(`#table-body-date-end${index}`).val();

    const pr_start_date = $("#start-date").val();
    const pr_end_date = $("#end-date").val();

    // Validar que ambas fechas estén ingresadas
    if (start_date == "" || end_date == "") {
        alert("Asegúrate de agregar ambas fechas.");
        return;
    }

    if (new Date(start_date) > new Date(end_date)) {
        alert("La fecha de inicio no puede ser mayor a la fecha de fin.");
        return;
    }

    if (
        new Date(start_date) < new Date(pr_start_date) ||
        new Date(end_date) > new Date(pr_end_date)
    ) {
        alert("Las fechas ingresadas están fuera del rango permitido.");
        return;
    }

    periods[index].start_date = start_date;
    periods[index].end_date = end_date;
    // paintDates(index);
}

function setPeriod() {
    const start_date = $("#period-startdate").val();
    const end_date = $("#period-enddate").val();
    const color = $("#period-color").val();

    if (start_date == "" || end_date == "") {
        alert("Debes seleccionar ambas fechas");
    }

    if (new Date(start_date) > new Date(end_date)) {
        alert("La fecha de inicio no puede ser mayor a la fecha de fin.");
        return;
    }

    periods.push({
        index: periods.length,
        id: null,
        start_date: start_date,
        end_date: end_date,
        color: color,
        products: [],
    });

    paintPeriod();
}

function paintPeriod() {
    var html = ``;
    periods.forEach((period, i) => {
        html += `
            <tr>
                <td>${i + 1}</td>
                <td>
                    <div class="input-group">
                        <input type="date" class="form-control" id="table-body-date-start${i}" value="${
            period.start_date
        }" oninput="setDates(${i})">
                        <input type="date" class="form-control" id="table-body-date-end${i}" value="${
            period.end_date
        }" oninput="setDates(${i})">
                    </div>
                </td>
                <td>
                    <input type="color" class="form-control" id="table-body-period-color${i}" value="${
            period.color
        }" oninput="setColor(${i}, this.value)">
                </td>
                <td id="period${i}-products-count">${
            period.products.length
        }</td>
                <td>
                <button type="button" class="btn btn-warning btn-sm" onclick="periodProducts(${i})"><i class="bi bi-box-fill"></i> Productos</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deletePeriod(${i})"><i class="bi bi-trash-fill"></i> Eliminar</button>
                </td>
            </tr>
        `;
    });
    $("#table-periods").html(html);
}

function deletePeriod(index) {
    periods.splice(index, 1);
    paintPeriod();
}

function periodProducts(index) {
    $("#product-modal-period-startdate").val(periods[index].start_date);
    $("#product-modal-period-enddate").val(periods[index].end_date);
    $("#period-index").val(index);
    $("#productsModal").modal("show");

    paintProducts(index);
}

function editProduct(index) {
    var html = ``;
    $("#dateModal").modal("show");
    $("#product-index").val(index);
    $("#product-name").val(selected_products[index].name);
    //paintDates(index);
}

function submitForm() {
    $("#products").val(JSON.stringify(selected_products));
    $("#changes").val(JSON.stringify(changes));
}

function setChange() {
    var today = convertDate(new Date());
    var change = $("#review-change").val();
    var no_review = $("#no-review").val();

    changes.push({
        index: changes.length,
        no_review: no_review,
        date: today,
        description: change,
    });

    paintChanges();

    $("#changeModal").modal("hide");
}

function convertDate(date) {
    if (date instanceof Date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0"); // Los meses se cuentan desde 0
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    } else {
        return date;
    }
}

function paintChanges() {
    var html = "";
    if (changes.length > 0) {
        changes.forEach((change, i) => {
            console.log(2);
            html += paintChange(change, i);
        });
    }
    $("#change-table-body").html(html);
}

function paintChange(change, i) {
    var date = change.date ?? convertDate(new Date(change.created_at));
    changes[i].date = date;
    return `
        <tr>
            <th scope="row">${i + 1} </th>
            <td>${date}</td>
            <td>${change.no_review}</td>
            <td>${change.description}</td>
            <td>
                <button class="btn btn-danger btn-sm" type="button" onclick="deleteChange(${i})"><i class="bi bi-trash-fill"></i> Eliminar</button>
            </td>
        </tr>
    `;
}

function deleteChange(index) {
    changes.splice(index, 1);
    paintChanges();
}
