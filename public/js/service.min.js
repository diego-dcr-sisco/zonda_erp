var services_data = [];
var selected_services = [];
var service_costs = [];

$(function () {
    selected_services = contain_selected_services || [];
    if (typeof view !== "undefined") {
        if (view === "order") {
            console.log("View is order");
            displaySelectedServicestoOrder();
        } else if (view === "contract" || view === "renew") {
            console.log("View is contract");
            displaySelectedServicestoContract();
        }
    }

    if (typeof updated_services !== "undefined") {
        updated_services = [];
    }
});

function searchService() {
    var item = $("#services-list");
    var html = "";
    var modal = $("#serviceModal");

    if ($("#search-service-input").val().length > 0) {
        getService(function (services) {
            services_data = services;
            if (services.length > 0) {
                // Construir la tabla de servicios
                html = `
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50px">
                                        <input type="checkbox" id="selectAllServices" onchange="toggleSelectAllServices(this)">
                                    </th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>LÃ­nea</th>
                                    <th>Plagas</th>
                                    <th>MÃ©todos</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody>`;

                // Agregar cada servicio como una fila en la tabla
                services.forEach((service) => {
                    const isSelected = selected_services.some(
                        (item) => item.id == service.id,
                    );
                    html += `
                                <tr class="service-row ${
                                    isSelected ? "table-primary" : ""
                                }">
                                    <td>
                                        <input type="checkbox" class="service-checkbox"
                                            name="service_ids[]"
                                            value="${service.id}"
                                            data-id="${service.id}"
                                            data-name="${service.name}"
                                            data-type="${service.type}"
                                            data-line="${service.bussLine}"
                                            data-cost="${service.cost}"
                                            data-prefix="${service.prefix}"
                                            ${isSelected ? "checked" : ""}
                                            onchange="setService(${
                                                service.id
                                            })">
                                    </td>
                                    <td>
                                        <strong>${service.name}</strong>
                                    </td>
                                    <td>${service.type}</td>
                                    <td>${service.bussLine}</td>
                                    <td>
                                        <small class="text-muted">${shortenString(
                                            service.pests.length > 0
                                                ? service.pests.join(", ")
                                                : "S/P",
                                        )}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">${shortenString(
                                            service.appMethods.length > 0
                                                ? service.appMethods.join(", ")
                                                : "S/M",
                                        )}</small>
                                    </td>
                                    <td class="text-success">
                                        $${service.cost}
                                    </td>
                                </tr>`;
                });

                // Cerrar la tabla
                html += `
                            </tbody>
                        </table>
                    </div>`;

                item.html(html);
                modal.modal("show");

                // Inicializar funcionalidades
                initializeServiceModal();
            } else {
                item.html(
                    '<div class="alert alert-danger">No se encontraron servicios</div>',
                );
                modal.modal("show");
            }
        });
    } else {
        alert("Debes introducir al menos 1 dato de bÃºsqueda.");
    }
}

function shortenString(str) {
    var size = 30;
    if (str.length > size) {
        return str.substring(0, size) + "...";
    }
    return str;
}

function getService(callback) {
    const formData = new FormData();
    const csrfToken = $('meta[name="csrf-token"]').attr("content");
    var url = "";

    url = $("#url-service-input").val();
    formData.append("search_service_input", $("#search-service-input").val());

    $.ajax({
        url: url,
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            const services = response.services;
            const service_types = response.service_types;
            const business_lines = response.business_lines;
            const pests = response.pests;
            const app_methods = response.app_methods;

            if (services.length > 0) {
                callback(
                    services.map((service, i) => {
                        return {
                            id: service.id,
                            prefix: service.prefix,
                            name: service.name,
                            type: service_types[i],
                            bussLine: business_lines[i],
                            pests: pests[i],
                            appMethods: app_methods[i],
                            status: selected_services.some(
                                (item) => item.id == service.id,
                            ),
                            cost: service.cost ?? "---",
                            description: service.description,
                            //settings: [],
                        };
                    }),
                );
            } else {
                callback([]);
            }
        },
        error: function (error) {
            console.error(error);
            callback([]);
        },
    });
}

// FunciÃ³n para inicializar el modal de servicios
function initializeServiceModal() {
    // Inicializar bÃºsqueda en tiempo real
    $("#serviceSearch").on("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = $(".service-row");

        rows.each(function () {
            const $row = $(this);
            const name = $row.find("td:nth-child(3)").text().toLowerCase();
            const type = $row.find("td:nth-child(4)").text().toLowerCase();
            const line = $row.find("td:nth-child(5)").text().toLowerCase();

            if (
                name.includes(searchTerm) ||
                type.includes(searchTerm) ||
                line.includes(searchTerm)
            ) {
                $row.show();
            } else {
                $row.hide();
            }
        });
    });

    // Actualizar contador
    updateSelectedServicesCount();
}

// FunciÃ³n para seleccionar/deseleccionar todos los servicios
function toggleSelectAllServices(checkbox) {
    const isChecked = $(checkbox).is(":checked");
    $(".service-checkbox").prop("checked", isChecked).trigger("change");
}

// FunciÃ³n para actualizar contador de servicios seleccionados
function updateSelectedServicesCount() {
    const selectedCount = $(".service-checkbox:checked").length;
    $("#selected-services-count").text(
        selectedCount + " servicio(s) seleccionado(s)",
    );

    // Calcular costo total
    let totalCost = 0;
    $(".service-checkbox:checked").each(function () {
        totalCost += parseFloat($(this).data("cost")) || 0;
    });

    $("#total-cost").text("Total: $" + totalCost.toFixed(2));
}

// FunciÃ³n para seleccionar/deseleccionar servicio
function setService(service_id) {
    const checkbox = $(`.service-checkbox[value="${service_id}"]`);
    const isChecked = checkbox.is(":checked");
    const row = checkbox.closest("tr");

    if (isChecked) {
        // Agregar servicio a seleccionados
        const service = services_data.find((item) => item.id == service_id);
        if (
            service &&
            !selected_services.some((item) => item.id == service_id)
        ) {
            selected_services.push({
                id: service_id,
                prefix: service.prefix,
                name: service.name,
                type: service.type,
                line: service.bussLine,
                cost: service.cost,
                description: service.description,
                //settings: [],
            });

            if (typeof services_configuration !== "undefined") {
                services_configuration.push({
                    service_id: service.id,
                    description: service.description,
                });
            }
        }
        row.addClass("table-primary");
    } else {
        // Remover servicio de seleccionados
        const index = selected_services.findIndex(
            (item) => item.id == service_id,
        );
        if (index !== -1) {
            selected_services.splice(index, 1);
        }
        row.removeClass("table-primary");
    }

    updateSelectedServicesCount();
}

// FunciÃ³n para confirmar selecciÃ³n de servicios
function confirmServicesSelection() {
    if (selected_services.length > 0) {
        // Mostrar servicios seleccionados
        displaySelectedServicestoContract();
        // Cerrar modal
        $("#serviceModal").modal("hide");

        // Mostrar mensaje de Ã©xito
        showSuccessMessage(
            selected_services.length +
                " servicio(s) seleccionado(s) correctamente",
        );
    } else {
        showErrorMessage("Por favor selecciona al menos un servicio");
    }
}

function showSuccessMessage(message) {
    alert(`âœ… ${message}`);
}

function showErrorMessage(message) {
    alert(`âŒ ${message}`);
}

// FunciÃ³n para mostrar servicios seleccionados
function displaySelectedServicestoContract() {
    const $container = $("#selected-services-container");
    let html = "";

    if (selected_services.length > 0) {
        html = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>LÃ­nea</th>
                            <th>Configuraciones</th>
                            <!--th>Fechas generadas</th-->
                            <th>Ã“rdenes generadas</th>
                            <th>Costo</th>  
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>`;

        let totalCost = 0;
        let totalOrders = 0;

        selected_services.forEach((service) => {
            contract_configurations = contract_configurations || [];

            c_configs = contract_configurations.filter(
                (c) => c.service_id == service.id,
            );

            totalCost += parseFloat(service.cost) || 0;

            const configCount = c_configs ? c_configs.length : 0;
            const datesCount = c_configs
                ? c_configs.reduce(
                      (total, item) =>
                          total + (item.dates ? item.dates.length : 0),
                      0,
                  )
                : 0;
            const ordersCount = c_configs
                ? c_configs.reduce(
                      (total, item) =>
                          total + (item.orders ? item.orders.length : 0),
                      0,
                  )
                : 0;

            totalOrders += ordersCount;

            html += `
                        <tr id="table-service${service.id}">
                            <td><strong>${service.name}</strong></td>
                            <td>${service.type}</td>
                            <td>${service.line}</td>
                            <td id="service${
                                service.id
                            }-count-configs">${configCount}</td>
                            <!--td id="service${
                                service.id
                            }-count-dates">${datesCount}</td-->
                            <td id="service${
                                service.id
                            }-count-orders">${ordersCount}</td>
                            <td class="text-success">$${
                                service.cost ?? 0.0
                            }</td>  
                            <td class="d-flex justify-content-center gap-1">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="configureService(${
                                    service.id
                                })"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Configurar servicio">
                                    <i class="bi bi-gear-fill"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeService(${
                                    service.id
                                })"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar servicio">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>`;
        });

        html += `
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total:</td>
                            <td class="fw-bold">${totalOrders}</td>
                            <td class="fw-bold text-success">$${totalCost.toFixed(
                                2,
                            )}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
    } else {
        html =
            '<div class="alert alert-danger">No hay servicios seleccionados</div>';
    }

    $container.html(html);
}

// FunciÃ³n para mostrar servicios seleccionados
function displaySelectedServicestoOrder() {
    const $container = $("#selected-services-container");
    let html = "";

    if (selected_services.length > 0) {
        html = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Prefijo</th>
                            <th>Tipo</th>
                            <th>LÃ­nea</th>
                            <th>Precio</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>`;

        let totalCost = 0;
        let totalOrders = 0;

        selected_services.forEach((service, index) => {
            contract_configurations = contract_configurations || [];

            c_configs = contract_configurations.filter(
                (c) => c.service_id == service.id,
            );

            totalCost += parseFloat(service.cost) || 0;

            const configCount = c_configs ? c_configs.length : 0;
            const datesCount = c_configs
                ? c_configs.reduce(
                      (total, item) =>
                          total + (item.dates ? item.dates.length : 0),
                      0,
                  )
                : 0;
            const ordersCount = c_configs
                ? c_configs.reduce(
                      (total, item) =>
                          total + (item.orders ? item.orders.length : 0),
                      0,
                  )
                : 0;

            totalOrders += ordersCount;

            html += `
                        <tr id="table-service${service.id}">
                            <td>${index+1}</td>
                            <td><strong>${service.name}</strong></td>
                            <td>${service.prefix_name}</td>
                            <td>${service.type}</td>
                            <td>${service.line}</td>
                            <td class="text-success">$${
                                service.cost ?? 0.0
                            }</td>  
                            <td class="d-flex justify-content-center gap-1">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="configureService(${
                                    service.id
                                })"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Configurar servicio">
                                    <i class="bi bi-gear-fill"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeService(${
                                    service.id
                                })"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar servicio">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>`;
        });
    } else {
        html =
            '<div class="alert alert-danger">No hay servicios seleccionados</div>';
    }

    $container.html(html);
}

// FunciÃ³n para remover servicio individual
function removeService(service_id) {
    // Obtener informaciÃ³n del servicio
    const service = selected_services.find((s) => s.id == service_id);
    const serviceName = service ? service.name : "Servicio";

    // Obtener informaciÃ³n de configuraciones y Ã³rdenes
    let configsCount = 0;
    let ordersCount = 0;
    let ordersByStatus = {};

    if (typeof contract_configurations !== "undefined") {
        const serviceConfigs = contract_configurations.filter(
            (cc) => cc.service_id == service_id,
        );
        configsCount = serviceConfigs.length;

        // Contar Ã³rdenes y por estado
        serviceConfigs.forEach((config) => {
            if (config.orders && Array.isArray(config.orders)) {
                ordersCount += config.orders.length;

                config.orders.forEach((order) => {
                    const status = order.status_id || 1;
                    if (!ordersByStatus[status]) {
                        ordersByStatus[status] = 0;
                    }
                    ordersByStatus[status]++;
                });
            }
        });
    }

    // Crear mensaje detallado
    let message = `Â¿EstÃ¡ seguro de que desea eliminar el servicio "${serviceName}"?\n\n`;

    if (configsCount > 0) {
        message += `ðŸ“‹ Configuraciones: ${configsCount}\n`;
    }

    if (ordersCount > 0) {
        message += `ðŸ“¦ Ã“rdenes de servicio: ${ordersCount}\n`;

        // Agregar desglose de Ã³rdenes por estado si existen
        if (Object.keys(ordersByStatus).length > 0) {
            message += `\nDesglose de Ã³rdenes:\n`;
            if (ordersByStatus[1])
                message += `â€¢ Pendientes: ${ordersByStatus[1]}\n`;
            if (ordersByStatus[2])
                message += `â€¢ En progreso: ${ordersByStatus[2]}\n`;
            if (ordersByStatus[3])
                message += `â€¢ Completadas: ${ordersByStatus[3]}\n`;
            if (ordersByStatus[4])
                message += `â€¢ Canceladas: ${ordersByStatus[4]}\n`;
        }
    }

    message += `\nâš ï¸  ADVERTENCIA: Esta acciÃ³n eliminarÃ¡ todas las configuraciones y Ã³rdenes asociadas a este servicio.`;

    if (!confirm(message)) {
        return; // El usuario cancelÃ³ la acciÃ³n
    }

    // Desmarcar checkbox
    $(`.service-checkbox[value="${service_id}"]`)
        .prop("checked", false)
        .trigger("change");

    // AnimaciÃ³n de eliminaciÃ³n
    $("#table-service" + service_id).fadeOut(300, function () {
        $(this).remove();
    });

    // Remover de servicios seleccionados
    selected_services = selected_services.filter((s) => s.id != service_id);

    // Manejar configuraciones del contrato
    if (typeof contract_configurations !== "undefined") {
        contract_configurations = contract_configurations.filter(
            (cc) => cc.service_id != service_id,
        );
        $("#contract-configurations").val(
            JSON.stringify(contract_configurations),
        );
    }

    // Manejar configuraciÃ³n de servicios
    if (typeof services_configuration !== "undefined") {
        services_configuration = services_configuration.filter(
            (sc) => sc.service_id != service_id,
        );
        $("#services").val(JSON.stringify(services_configuration));
    }

    // Actualizar visualizaciÃ³n
    displaySelectedServicestoContract();

    // Mostrar mensaje de Ã©xito
    let successMessage = `âœ… Servicio "${serviceName}" eliminado correctamente.`;
    if (configsCount > 0) {
        successMessage += `\nâ€¢ ${configsCount} configuraciÃ³n(es) eliminada(s)`;
    }
    if (ordersCount > 0) {
        successMessage += `\nâ€¢ ${ordersCount} orden(es) de servicio eliminada(s)`;
    }

    alert(successMessage);
}

// FunciÃ³n para limpiar todos los servicios seleccionados
function clearAllServices() {
    $(".service-checkbox").prop("checked", false).trigger("change");
    selected_services = [];
    displaySelectedServicestoContract();
    showSuccessMessage("Todos los servicios han sido removidos");
}

function configureService(service_id) {
    const service = selected_services.find((item) => item.id == service_id);

    if (!service) {
        alert("Servicio no encontrado");
        return;
    }

    if (typeof updated_services !== "undefined") {
        updated_services.push(service_id);
        $("#updated-services").val(JSON.stringify(updated_services));
    }

    $("#configurations-list").empty();
    $("#configureServiceModalLabel").text(
        "Configurar Servicio: " + service.name,
    );
    
    setServiceConfig(service);
    $("#configureServiceModal").modal("show");

    $("#serviceModal-prefix").val(getPrefixLabel(service.prefix));
    $("#serviceModal-service").val(service.name);
    $("#serviceModal-type").val(service.type);
    $("#serviceModal-bsline").val(service.line);
    $("#serviceModal-cost").val(service.cost);
}

function getPrefixLabel(prefix) {
    const prefixLabels = {
        1: "Control/Perimetro",
        2: "AplicaciÃ³n quÃ­mica",
        3: "AplicaciÃ³n de gel",
        4: "Otro",
    };
    return prefixLabels[prefix] || "Otro";
}

function setServiceConfig(service) {
    $("#service-prefix").val(getPrefixLabel(service.prefix));
    $("#service-name").val(service.name);
    $("#service-type").val(service.type);
    $("#service-line").val(service.line);
    $("#service-cost").val(service.cost);
    $("#service-id").val(service.id);
}

// FunciÃ³n para contar Ã³rdenes por estado 
function countOrdersByStatus(orders) {
    if (!orders || !Array.isArray(orders)) {
        return {
            pending: 0,
            inProgress: 0,
            completed: 0,
            cancelled: 0,
            total: 0,
        };
    }

    return {
        pending: orders.filter((order) => order.status_id === 1).length,
        inProgress: orders.filter((order) => order.status_id === 2).length,
        completed: orders.filter((order) => order.status_id === 3).length,
        cancelled: orders.filter((order) => order.status_id === 4).length,
        total: orders.length,
    };
}

// FunciÃ³n para obtener el resumen de Ã³rdenes por servicio 
function getServiceOrdersSummary(service_id) {
    if (typeof contract_configurations === "undefined") {
        return {
            configCount: 0,
            datesCount: 0,
            ordersCount: 0,
            ordersByStatus: {
                pending: 0,
                inProgress: 0,
                completed: 0,
                cancelled: 0,
                total: 0,
            },
        };
    }

    const serviceConfigs = contract_configurations.filter(
        (c) => c.service_id == service_id,
    );
    const configCount = serviceConfigs.length;

    let datesCount = 0;
    let allOrders = [];

    serviceConfigs.forEach((config) => {
        datesCount += config.dates ? config.dates.length : 0;
        if (config.orders && Array.isArray(config.orders)) {
            allOrders = allOrders.concat(config.orders);
        }
    });

    const ordersByStatus = countOrdersByStatus(allOrders);

    return {
        configCount,
        datesCount,
        ordersCount: allOrders.length,
        ordersByStatus,
    };
}

// FunciÃ³n para actualizar el resumen de un servicio especÃ­fico
function updateServiceSummary(service_id) {
    const summary = getServiceOrdersSummary(service_id);

    $(`#service${service_id}-count-configs`).text(summary.configCount);
    $(`#service${service.id}-count-dates`).text(summary.datesCount);
    $(`#service${service.id}-count-orders`).text(summary.ordersCount);

    // Opcional: Actualizar tooltip o informaciÃ³n adicional sobre estados
    const statusInfo = `Pendientes: ${summary.ordersByStatus.pending}, En progreso: ${summary.ordersByStatus.inProgress}, Completadas: ${summary.ordersByStatus.completed}, Canceladas: ${summary.ordersByStatus.cancelled}`;
    $(`#service${service_id}-count-orders`).attr("title", statusInfo);
}

// FunciÃ³n para obtener el resumen general de todos los servicios
function getOverallOrdersSummary() {
    if (
        typeof selected_services === "undefined" ||
        selected_services.length === 0
    ) {
        return {
            totalServices: 0,
            totalConfigs: 0,
            totalDates: 0,
            totalOrders: 0,
            ordersByStatus: {
                pending: 0,
                inProgress: 0,
                completed: 0,
                cancelled: 0,
            },
        };
    }

    let totalConfigs = 0;
    let totalDates = 0;
    let totalOrders = 0;
    const ordersByStatus = {
        pending: 0,
        inProgress: 0,
        completed: 0,
        cancelled: 0,
    };

    selected_services.forEach((service) => {
        const summary = getServiceOrdersSummary(service.id);
        totalConfigs += summary.configCount;
        totalDates += summary.datesCount;
        totalOrders += summary.ordersCount;

        ordersByStatus.pending += summary.ordersByStatus.pending;
        ordersByStatus.inProgress += summary.ordersByStatus.inProgress;
        ordersByStatus.completed += summary.ordersByStatus.completed;
        ordersByStatus.cancelled += summary.ordersByStatus.cancelled;
    });

    return {
        totalServices: selected_services.length,
        totalConfigs,
        totalDates,
        totalOrders,
        ordersByStatus,
    };
}
